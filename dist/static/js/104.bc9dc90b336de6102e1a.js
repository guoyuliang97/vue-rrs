webpackJsonp([104],{HWhX:function(t,e){},a6o5:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=i("Xxa5"),o=i.n(a),n=i("exGp"),s=i.n(n),r=i("/nBy"),l=i("DjrJ"),c=i("c18A"),d=i("dbwY"),h=i("7+uW"),g=i("sbrb"),u=i.n(g);h.default.use(u.a);l.a,c.a,d.a,r.a;h.default.use(u.a);var p={name:"storyPublish",components:{Head:l.a,Foot:c.a,City:d.a,Loading:r.a},data:function(){return{country:"",province:"",city:"",xian:"",title:"",content:"",address:"",region:[],cover_image:[],dialogImageUrl:"",dialogVisible:!1,dialogUrl:"",api:this.GLOBAL.baseURL,options:[],props:{value:"kind_id",label:"kind_name"},storyId:"",local:"",imgList:[],clickIndex:-1,xianList:[],fileAllList:[],isLoading:!1,param:"",index:0}},methods:{seletI:function(t){var e=this;return s()(o.a.mark(function i(){return o.a.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return e.uploadImg=2,e.isLoading=!0,i.next=4,e.xunhuan(t);case 4:case"end":return i.stop()}},i,e)}))()},xunhuan:function(t){var e=this;return s()(o.a.mark(function i(){var a;return o.a.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(a=new FormData,!t.target.files.length){i.next=10;break}if(!(t.target.files.length>10)){i.next=9;break}return e.$message({type:"info",message:"最多一次上传10张!"}),e.isLoading=!1,e.$refs.file.value="",i.abrupt("return",!1);case 9:e.panduan(t.target.files,a);case 10:case"end":return i.stop()}},i,e)}))()},panduan:function(t,e){var i=null,a=this;if(a.index==t.length)return a.index=0,a.param=e,void a.upload();var o=t[this.index];if(!("image/jpeg"===o.type||"image/jpg"===o.type||"image/png"===o.type))return alert("请上传图片格式IPEG/PNG/JPG"),a.isLoading=!1,!1;u.a.getData(o,function(){u.a.getAllTags(this),i=u.a.getTag(this,"Orientation")});var n=new FileReader;n.onload=function(o){var n=new Image;n.src=o.target.result,n.onload=function(){var o=this.naturalWidth,n=this.naturalHeight,s=document.createElement("canvas"),r=s.getContext("2d");s.width=o,s.height=n,r.drawImage(this,0,0,o,n);var l=null;if(""!=i&&1!=i){switch(i){case 6:a.rotateImg(this,"left",s);break;case 8:a.rotateImg(this,"right",s);break;case 3:a.rotateImg(this,"turntwo",s)}l=s.toDataURL("image/jpeg",.8),e.append("file[]",l)}else l=s.toDataURL("image/jpeg",.8),e.append("file[]",l);a.index++,a.panduan(t,e)}},n.readAsDataURL(o)},rotateImg:function(t,e,i){if(null!=t){var a=t.height,o=t.width,n=2;null==n&&(n=0),"right"==e?++n>3&&(n=0):--n<0&&(n=3);var s=90*n*Math.PI/180,r=i.getContext("2d");switch(n){case 0:i.width=o,i.height=a,r.drawImage(t,0,0);break;case 1:i.width=a,i.height=o,r.rotate(s),r.drawImage(t,0,-a);break;case 2:i.width=o,i.height=a,r.rotate(s),r.drawImage(t,-o,-a);break;case 3:i.width=a,i.height=o,r.rotate(s),r.drawImage(t,-o,0)}}},upload:function(){var t=this;this.param.append("token",localStorage.getItem("token")),this.$http.post(this.api+"/home/Upload/upload_many",this.param).then(function(e){if(1==e.data.code){for(var i=e.data.data,a=0;a<i.length;a++)t.fileAllList.push({url:i[a].domain+i[a].image_url}),t.cover_image.push({image_id:i[a].image_id});t.$refs.file.value="",t.isLoading=!1}else 3==e.data.code?t.$http.post(t.api+"/home/index/token").then(function(e){localStorage.setItem("token",e.data.data),t.upload()}):0==e.data.code&&(alert(e.data.msg),t.isLoading=!1,t.$refs.file.value="")}).catch(function(e){t.$refs.file.value="",t.isLoading=!1})},uploadDelet:function(t,e){var i=[];this.fileAllList.splice(e,1);for(var a=0;a<this.cover_image.length;a++)i.push(this.cover_image[a].image_id);var o=i.indexOf(t.image_Id);this.cover_image.splice(o,1)},uploadLook:function(t,e){this.dialogVisible=!0,this.dialogUrl=t.url},remakeLocal:function(){this.local="",this.country="",this.province="",this.city="",this.xian=""},deleteImg:function(t,e){this.imgList.splice(e,1)},lookImg:function(t,e){this.dialogImageUrl=t.imgUrl,this.dialogVisible=!0},leavePhoto:function(t,e){this.clickIndex=-1},choosePhoto:function(t,e){this.clickIndex!=e&&(this.clickIndex=e)},onSubmit:function(){if(this.title)if(this.content)if(this.cover_image.length||this.imgList.length)if(this.xianList.length)if(this.xian[1])if(this.storyId){if(this.imgList.length)for(var t=0;t<this.imgList.length;t++)this.cover_image.push({image_id:this.imgList[t].image_id});this.remakeStory()}else this.createStory();else this.$message({type:"info",message:"请填写故事区域完整"});else if(this.city[1])if(this.storyId){if(this.imgList.length)for(var e=0;e<this.imgList.length;e++)this.cover_image.push({image_id:this.imgList[e].image_id});this.remakeStory()}else this.createStory();else this.$message({type:"info",message:"请填写故事区域完整"});else this.$message({type:"info",message:"请上传照片"});else this.$message({type:"info",message:"请填写故事内容"});else this.$message({type:"info",message:"请填写标题"})},remakeStory:function(){var t=this;this.$http.post(this.api+"/home/Story/save_story",{token:localStorage.getItem("token"),title:this.title,content:this.content,country:this.country[1],province:this.province[1],city:this.city[1],region:this.xian[1],country_id:this.country[0],province_id:this.province[0],city_id:this.city[0],region_id:this.xian[0],kind_id:this.region[this.region.length-1],image:this.cover_image,cover_image:this.cover_image[0].image_id,address:this.address,story_id:this.storyId}).then(function(e){1==e.data.code?t.$router.push("/storyList"):3==e.data.code?t.$http.post(t.api+"/home/index/token").then(function(e){localStorage.setItem("token",e.data.data),t.remakeStory()}):alert(e.data.msg)})},onRest:function(){},createStory:function(){var t=this;this.$http.post(this.api+"/home/Story/save_story",{token:localStorage.getItem("token"),title:this.title,content:this.content,country:this.country[1],province:this.province[1],city:this.city[1],region:this.xian[1],country_id:this.country[0],province_id:this.province[0],city_id:this.city[0],region_id:this.xian[0],kind_id:this.region[this.region.length-1],image:this.cover_image,cover_image:this.cover_image[0].image_id,address:this.address}).then(function(e){1==e.data.code?t.$router.push("/storyList"):3==e.data.code?t.$http.post(t.api+"/home/index/token").then(function(e){localStorage.setItem("token",e.data.data),t.createStory()}):0==e.data.code&&alert(e.data.msg)})},checkXian:function(t){this.xianList=t},selectCountry:function(t){this.country=t},selectProvince:function(t){this.province=t},selectCity:function(t){this.city=t},selectXian:function(t){this.xian=t},creatStory:function(){var t=this;this.$http.post(this.api+"/home/Kind/kindlist",{token:localStorage.getItem("token")}).then(function(e){if(1==e.data.code)for(var i in e.data.data)t.options.push(e.data.data[i]);else 3==e.data.code?t.$http.post(t.api+"/home/index/token").then(function(e){localStorage.setItem("token",e.data.data),t.creatStory()}):alert(e.data.msg)})},getStory:function(){var t=this;this.$http.post(this.api+"/home/Story/get_story",{token:localStorage.getItem("token"),story_id:this.storyId,visit:0}).then(function(e){if(1==e.data.code){var i=e.data.data;t.title=i.title,t.country=[i.country_id,i.country],t.province=[i.province_id,i.province],t.city=[i.city_id,i.city],t.xian=[i.region_id,i.region],i.province==i.city?t.local=i.country+" "+i.province+"市 "+i.city+"市 "+i.region:t.local=i.country+" "+i.province+"省 "+i.city+"市 "+i.region,t.address=i.address;for(var a=0;a<i.kind_id.split(",").length;a++)t.region.push(parseInt(i.kind_id.split(",")[a]));for(var o=0;o<i.image.length;o++)t.imgList.push({imgUrl:i.image[o].domain+i.image[o].image_url,image_id:i.image[o].image_id});t.content=i.content}else 3==e.data.code||alert(e.data.msg)})}},mounted:function(){this.creatStory(),this.storyId&&this.getStory()},created:function(){this.storyId=this.$route.query.storyId}},m={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("Head",{attrs:{type:"storyPublish"}}),t._v(" "),i("div",{staticStyle:{width:"700px","text-align":"left",margin:"130px auto"}},[t._m(0),t._v(" "),i("el-form",{ref:"form",attrs:{"label-width":"80px"}},[i("el-form-item",{attrs:{label:"故事标题"}},[i("el-input",{attrs:{type:"text"},model:{value:t.title,callback:function(e){t.title=e},expression:"title"}})],1),t._v(" "),i("el-form-item",{attrs:{label:"故事地区"}},[i("div",{directives:[{name:"show",rawName:"v-show",value:t.local,expression:"local"}],staticStyle:{display:"flex","justify-content":"flex-start"}},[i("el-input",{attrs:{type:"text"},model:{value:t.local,callback:function(e){t.local=e},expression:"local"}}),t._v(" "),i("el-button",{staticStyle:{"margin-left":"10px"},on:{click:t.remakeLocal}},[t._v("修改")])],1),t._v(" "),i("City",{directives:[{name:"show",rawName:"v-show",value:!t.local,expression:"!local"}],attrs:{type:"1"},on:{selectXian:t.selectXian,checkXian:t.checkXian,selectCountry:t.selectCountry,selectProvince:t.selectProvince,selectCity:t.selectCity}})],1),t._v(" "),i("el-form-item",{attrs:{label:"故事地点"}},[i("el-input",{staticStyle:{width:"215px"},attrs:{type:"text"},model:{value:t.address,callback:function(e){t.address=e},expression:"address"}})],1),t._v(" "),i("el-form-item",{attrs:{label:"故事类型"}},[i("el-cascader",{attrs:{props:t.props,"change-on-select":"",options:t.options,filterable:"",clearable:""},model:{value:t.region,callback:function(e){t.region=e},expression:"region"}})],1),t._v(" "),i("el-form-item",{attrs:{label:"故事照片"}},[i("div",[i("div",{staticClass:"formFile"},[i("i",{staticClass:"el-icon-plus",staticStyle:{"font-size":"30px"}}),t._v(" "),i("input",{ref:"file",staticClass:"upload",attrs:{type:"file",multiple:""},on:{change:t.seletI}})])]),t._v(" "),t.fileAllList.length?i("div",{staticStyle:{display:"flex","flex-wrap":"wrap"}},t._l(t.fileAllList,function(e,a){return i("div",{directives:[{name:"dragging",rawName:"v-dragging",value:{item:e,list:t.fileAllList,group:"item"},expression:"{ item: item, list: fileAllList, group: 'item' }"}],key:a,staticStyle:{margin:"20px 0"}},[i("div",{staticStyle:{width:"150px",height:"150px","background-size":"auto 100%","margin-right":"20px"},style:{backgroundImage:"url("+e.url+")"}},[i("div",{staticStyle:{width:"150px",height:"150px",position:"relative","background-color":"rgba(0,0,0,.3)"}},[i("div",{staticStyle:{position:"absolute",top:"50%",left:"50%",width:"50px",height:"20px",display:"flex","justify-content":"flex-start","margin-left":"-25px","margin-top":"-10px"}},[i("i",{staticClass:"el-icon-zoom-in",staticStyle:{"font-size":"20px",color:"white",cursor:"pointer"},on:{click:function(i){t.uploadLook(e,a)}}}),i("i",{staticClass:"el-icon-delete",staticStyle:{"font-size":"20px",color:"white","margin-left":"10px",cursor:"pointer"},on:{click:function(i){t.uploadDelet(e,a)}}})])])])])})):t._e()]),t._v(" "),i("el-form-item",{directives:[{name:"show",rawName:"v-show",value:t.imgList.length,expression:"imgList.length"}],attrs:{label:"已传图片"}},[i("div",{staticStyle:{display:"flex","flex-wrap":"wrap"}},t._l(t.imgList,function(e,a){return i("div",{staticStyle:{width:"150px",height:"150px",position:"relative",margin:"0 20px 20px 0"},on:{mouseover:function(i){t.choosePhoto(e,a)},mouseleave:function(i){t.leavePhoto(e,a)}}},[i("img",{staticStyle:{width:"100%",height:"100%","border-radius":"5px"},attrs:{src:e.imgUrl}}),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:t.clickIndex==a,expression:"clickIndex == index"}],staticStyle:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0","background-color":"rgba(0,0,0,.5)","z-index":"999",display:"flex","justify-content":"center","align-items":"center"}},[i("i",{staticClass:"el-icon-zoom-in",staticStyle:{color:"#fff","font-size":"20px"},on:{click:function(i){t.lookImg(e,a)}}}),i("i",{staticClass:"el-icon-delete",staticStyle:{color:"#fff","font-size":"20px","margin-left":"10px"},on:{click:function(i){t.deleteImg(e,a)}}})])])}))]),t._v(" "),i("el-form-item",{attrs:{label:"故事内容"}},[i("el-input",{staticStyle:{"text-indent":"2rem"},attrs:{type:"textarea",autosize:{minRows:10}},model:{value:t.content,callback:function(e){t.content=e},expression:"content"}})],1),t._v(" "),i("el-form-item",[i("el-button",{attrs:{type:"primary",plain:""},on:{click:t.onSubmit}},[t._v(t._s(t.storyId?"立即修改":"立即创建"))]),t._v(" "),i("el-button",{attrs:{type:"primary",plain:""},on:{click:t.onRest}},[t._v("重置")])],1)],1)],1),t._v(" "),i("div",{staticStyle:{width:"1080px",margin:"0 auto"}},[i("Foot")],1),t._v(" "),i("el-dialog",{attrs:{visible:t.dialogVisible},on:{"update:visible":function(e){t.dialogVisible=e}}},[i("img",{attrs:{width:"100%",src:t.dialogUrl,alt:""}})]),t._v(" "),t.isLoading?i("div",{staticStyle:{position:"fixed",top:"0",left:"0",right:"0",bottom:"0","z-index":"990","background-color":"rgba(255,255,255,.8)",display:"flex","justify-content":"center","align-items":"center"}},[i("div",[i("Loading"),t._v(" "),i("p",[t._v("上传中")])],1)]):t._e()],1)},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticStyle:{margin:"20px 0"}},[e("h3",[this._v("创建我的故事")])])}]};var f=i("VU/8")(p,m,!1,function(t){i("HWhX")},"data-v-47c2e646",null);e.default=f.exports}});
//# sourceMappingURL=104.bc9dc90b336de6102e1a.js.map